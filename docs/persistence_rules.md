# Persistence Rules

This document is the source of truth describing how persistence is handled in this codebase. It is concise, prescriptive, and implementation-oriented — not a tutorial.

## General Principles

- **EF Core role:** EF Core is a persistence mechanism only; it must not drive domain model design.
- **Domain independence:** Domain model assemblies must not reference EF Core types or packages.
- **No lazy loading:** Lazy loading is forbidden; all navigation loading must be explicit to avoid hidden side effects.
- **Explicit configuration:** All mapping and behavior must be configured explicitly using `IEntityTypeConfiguration<T>` implementations.

## Entity Construction Rules

- **EF constructor:** Every entity must declare a private parameterless constructor for EF Core materialization.
- **Public constructors:** Any public constructors must enforce domain invariants and invariants must be validated at construction time.
- **No constructor-binding for domain params:** EF Core must never rely on public constructors that accept domain parameters as its primary construction mechanism. EF should materialize using the private parameterless constructor and property/field mapping only.

## Typed Identifiers

- **Strongly typed IDs:** All aggregate roots and entities use strongly typed identifier classes (for example `InventoryCountId`, `LocationId`).
- **Mapping typed IDs:** Typed identifier types are mapped to primitive storage (UUID) using `ValueConverter` implementations in the EF mapping layer.
- **FKs use typed IDs:** Foreign key properties and navigation keys use the same typed identifier types (not raw `Guid`/`string`).

## Value Objects

- **Immutability:** Value objects must be immutable. Their state is set at creation and cannot be changed after construction.
- **Mapping:** Value objects are mapped with `OwnsOne` / owned entity configuration in EF Core.
- **Optional owned values:** Optional value objects are modeled as nullable owned navigations (the owning property can be null).
- **Scalar nullability:** Inner scalar properties of value objects must not be nullable unless the domain explicitly requires null as a valid value.

## Collections and Backing Fields

- **Read-only exposure:** Collections on aggregates are exposed to consumers as `IReadOnlyCollection<T>` (or another read-only interface).
- **Private backing fields:** EF Core maps collection navigations via private backing fields. Domain code must mutate the backing field through explicit methods on the aggregate (e.g., `AddLine(...)`, `RemoveLine(...)`).
- **Explicit field config:** Backing fields must be explicitly configured in the entity mapping (`HasField`, `UsePropertyAccessMode`) to avoid accidental reliance on conventions.
- **Public collection properties:** Public mutable collection properties should be ignored by EF (or only treated as non-persisted helpers). The persisted collection must be backed by the private field and mapped as the navigation.

## Lists of Identifiers (uuid[] storage)

- **Value-list semantics:** Lists of typed identifiers (for example `List<LocationId>`) represent value data, not relations, and are stored as `uuid[]` columns in PostgreSQL.
- **Mapping approach:** These lists are mapped using a custom `ValueConverter` (to/from `Guid[]`) together with a `ValueComparer` to ensure EF can detect changes.
- **No FK constraints:** Lists stored as `uuid[]` must not be modeled as foreign-key relationships; they are denormalized value data.

## Documents and Lines (Aggregate Structure)

- **Aggregate boundaries:** Documents (e.g., `InventoryCount`, `ShipmentOrder`) are aggregate roots and maintain their own transactional consistency boundaries.
- **Lines belong to aggregate:** Line items are entities within the document aggregate. They have identity but are not aggregate roots and must not be loaded or manipulated independently of their parent aggregate.
- **Parent reference:** Lines reference their parent document using the parent's typed identifier (not a raw primitive).

## Migrations

- **Apply migrations:** Database schema updates must be applied through `Database.Migrate()` in application startup or deployment migration jobs.
- **Avoid EnsureCreated():** `EnsureCreated()` is forbidden outside of throwaway/local experiments because it bypasses migrations and can cause drift; do not use it in integration, CI, or production code paths.
- **PostgreSQL compatibility:** All migrations and SQL generated by the project must be compatible with PostgreSQL (the targeted production DB).

## Integration Testing Constraints

- **Use PostgreSQL for tests:** Integration tests that validate persistence must run against PostgreSQL (for example via Docker/Testcontainers). Testcontainers or an equivalent is the preferred approach.
- **SQLite is not sufficient:** SQLite must not be used for persistence validation tests because its SQL dialect and behavior differ from PostgreSQL.
- **Testable rules:** Persistence rules and mappings must be verifiable by automated integration tests (schema, mapping, conversions, owned types, collection behavior, and value comparers).

## Mapping and Reliability Notes

- **Converters & comparers:** Any non-primitive mapping (typed IDs, lists, enums stored as text/integers) must provide both a `ValueConverter` and a `ValueComparer` when necessary so EF change tracking works reliably.
- **No shadow FKs for domain logic:** Avoid relying on shadow foreign keys for domain logic; foreign key values used by the domain should be explicit, typed properties.
- **Explicit indexes & constraints:** Indexes, uniqueness constraints, and FK constraints required by the domain must be declared in migrations and mapping code — do not rely solely on ad-hoc SQL.

## Enforcement and Review

- **Code review checks:** Follow these rules in all pull requests that introduce or modify persistence mappings. Mapping changes must include tests demonstrating correctness (materialization, save/load, change detection).

---

If anything here is unclear or needs a concrete mapping example for a specific domain type, request a minimal focused example and it will be added as an appendix rather than general guidance.
